---
title: "Exploratory Data Analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
```


```{r}
read_stata_dataset <- function(file_path) {
  haven::read_dta(file_path) %>% 
    haven::as_factor()
}

descriptive <- read_stata_dataset("data/OHIE_Public_Use_Files/OHIE_Data/oregonhie_descriptive_vars.dta")
state_programs <- read_stata_dataset("data/OHIE_Public_Use_Files/OHIE_Data/oregonhie_stateprograms_vars.dta")
survey12 <- read_stata_dataset("data/OHIE_Public_Use_Files/OHIE_Data/oregonhie_survey12m_vars.dta")
```

```{r}
all(descriptive$person_id == state_programs$person_id)
all(survey12$person_id == state_programs$person_id)
```

```{r}
survey0 <- haven::read_dta("data/OHIE_Public_Use_Files/OHIE_Data/oregonhie_survey0m_vars.dta") %>% 
  haven::as_factor()
```

```{r}
P <- descriptive %>% 
    select(person_id, household_id, numhh_list)

P$medicaid <- state_programs$ohp_all_ever_firstn_30sep2009 == 'Enrolled'
P$selected <- descriptive$treatment == "Selected"
```

ATE. Still need to come up with `P`.

Being selected in the Medicaid lottery leads to a 6% increase in probability of visiting the doctor in the next year.

```{r}
P %>% 
    group_by(selected) %>%
    summarise(doc_any = mean(doc_any_12m)) %>%
    spread(selected, doc_any) %>%
    mutate(diff = `1` - `0`)
```

Todos:

1. Not everyone who was picked in the lottery ended up registering for Medicaid. Plot `selected` vs `medicaid`. Some might ended up not enrolling, some might be found ineligible.


### Imperfect Randomization

Respondents are able to apply for all members of household. People in larger households are more likely to be eligible to Medicaid.

```{r}
P %>% 
  count(selected, numhh_list) %>% 
  spread(selected, n) %>% 
  mutate(pp_selected = `1` / (`0` + `1`))
```


### Dependence between units

Members of same household have correlated behaviour.

```{r}
# P %>% 
#   filter(as.numeric(as.character(numhh_list)) > 1) %>% 
#   arrange(household_id)
```


